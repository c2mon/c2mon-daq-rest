stages:
  - build
  - deploy 
  - sonar

# Get the settings file from c2mon project
before_script:
  - wget -O settings-ci.xml https://cern.ch/maven/settings-ci.xml

# Fully build and publish master branch
"Build and publish":
  stage: deploy
  script: 
    - mvn -q -U -B -T4 clean deploy --settings settings-ci.xml
  only:
    - master
    
# Just run tests on feature branches
build:
  stage: build
  script:
    - mvn -q -U -B clean test -DskipDockerBuild -DskipDockerTag --settings settings-ci.xml
  except:
    - master

"Sonar preview":
  stage: sonar
  script:
    - mvn -q -U -B clean compile sonar:sonar -Dmaven.test.skip=true -Dsonar.host.url=${SONAR_URL} -Dsonar.analysis.mode=preview -Dsonar.gitlab.commit_sha=$CI_BUILD_REF -Dsonar.gitlab.ref_name=$CI_BUILD_REF_NAME -Dsonar.gitlab.project_id=$CI_PROJECT_ID -Dsonar.gitlab.max_major_issues_gate=0 --settings settings-ci.xml --debug -X
  except:
    - master

"Sonar QA":
  stage: sonar
  script:
    - mvn package sonar:sonar -Dmaven.test.skip=true -Dsonar.host.url=${SONAR_URL} --settings settings-ci.xml
  only:
    - master
